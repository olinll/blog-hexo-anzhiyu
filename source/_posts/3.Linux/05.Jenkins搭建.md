---
title: Jenkins SpringBoot Docker æ­å»ºCICDæµæ°´çº¿éƒ¨ç½²
aliases:
date: 2025-12-27T15:39
updated: 2025-12-27T15:40
categories:
  - Linux
tags:
  - Jenkins
cover:
published: true
---
Jenkinsfileæ–‡ä»¶
```bash

pipeline {
    agent any

    environment {
        // å®šä¹‰Dockerä»“åº“ç›¸å…³ç¯å¢ƒå˜é‡
        DOCKER_REGISTRY_URL = 'dockerhub.kubekey.local'  // Dockerä»“åº“åœ°å€
        DOCKER_NAMESPACE = 'huanfa-wy-test'  // é•œåƒå‘½åç©ºé—´
        DOCKER_USERNAME = 'admin'  // ä»“åº“ç”¨æˆ·å
        DOCKER_PASSWORD = 'Harbor12345'  // ä»“åº“å¯†ç 
        
        // æ„å»ºç‰ˆæœ¬å·ï¼Œä½¿ç”¨Jenkinsæ„å»ºç¼–å·
        BASE_VERSION = "1.0.${BUILD_NUMBER}"
        
        // Mavené…ç½®æ–‡ä»¶è·¯å¾„
        MAVEN_SETTINGS = '/opt/maven/apache-maven-3.9.9/conf/settings-nexus-wuye.xml'
        
        // åº”ç”¨ç›®æ ‡ç«¯å£
        TARGET_PORT = '8080'
    }

    // å®šä¹‰æ„å»ºå·¥å…·
    tools {
        maven '3.9.9'  // Mavenç‰ˆæœ¬
        jdk '17'       // JDKç‰ˆæœ¬
    }

    // æµæ°´çº¿å‚æ•°å®šä¹‰
    parameters {
        // æ¨¡å—é€‰æ‹©å‚æ•°
        choice(
            name: 'MODULE_TO_BUILD',
            choices: [
                'wy-workflow'  // å¯æ„å»ºçš„æ¨¡å—åˆ—è¡¨
            ],
            description: 'é€‰æ‹©è¦æ„å»ºDockeré•œåƒçš„æ¨¡å—'
        )
        
        // ç¯å¢ƒé€‰æ‹©å‚æ•°
        choice(
            name: 'DEPLOY_PROFILE',
            choices: ['dev', 'test', 'prod'],  // Spring Bootç¯å¢ƒé…ç½®
            description: 'Spring Bootæ¿€æ´»çš„profile'
        )
    }

    // æµæ°´çº¿é˜¶æ®µå®šä¹‰
    stages {
        // ç¬¬ä¸€é˜¶æ®µï¼šä»£ç æ£€å‡º
        stage('Checkout') {
            steps {
                git branch: 'master',
                    url: 'http://192.168.2.10:3000/wuye_v2.0/hf-wy-workflow-biz.git',
                    credentialsId: 'huanfa-git'  // Gitå‡­æ®ID
            }
        }

        // ç¬¬äºŒé˜¶æ®µï¼šæ„å»ºæ‰€æœ‰æ¨¡å—
        stage('Build All Modules') {
            steps {
                // ä½¿ç”¨Mavenè·³è¿‡æµ‹è¯•æ‰§è¡Œæ„å»º
                sh "mvn clean install -Dmaven.test.skip=true -s ${MAVEN_SETTINGS}"
            }
        }

        // ç¬¬ä¸‰é˜¶æ®µï¼šæ›´æ–°Dockerfileä¸­çš„ç¯å¢ƒé…ç½®
        stage('Update Dockerfile Profiles') {
            steps {
                script {
                    echo "ğŸ”„ æ›´æ–°Dockerfileä¸­çš„Spring Profile"
                    echo "ç›®æ ‡Profile: ${params.DEPLOY_PROFILE}"
                    echo "ç›®æ ‡ç«¯å£: ${TARGET_PORT}"

                    // è·å–éœ€è¦æ„å»ºçš„æ¨¡å—åˆ—è¡¨
                    def modulesToBuild = getModulesToBuild()
                    
                    // éå†æ¯ä¸ªæ¨¡å—ï¼Œæ›´æ–°å…¶Dockerfile
                    for (module in modulesToBuild) {
                        updateDockerfileProfile(module)
                    }
                }
            }
        }

        // ç¬¬å››é˜¶æ®µï¼šæ„å»ºDockeré•œåƒ
        stage('Build Docker Images') {
            steps {
                script {
                    // è·å–éœ€è¦æ„å»ºçš„æ¨¡å—åˆ—è¡¨
                    def modulesToBuild = getModulesToBuild()
                    
                    // éå†æ¯ä¸ªæ¨¡å—ï¼Œæ„å»ºDockeré•œåƒ
                    for (module in modulesToBuild) {
                        buildDockerImage(module)
                    }
                }
            }
        }
    }

    // æµæ°´çº¿åç½®å¤„ç†
    post {
        // æ„å»ºæˆåŠŸåçš„å¤„ç†
        success {
            echo "ğŸ‰ æµæ°´çº¿æ‰§è¡ŒæˆåŠŸï¼"
            script {
                def modules = getModulesToBuild()
                echo "ğŸ“‹ æ„å»ºçš„é•œåƒåˆ—è¡¨ï¼š"
                modules.each { module ->
                    def imageName = "${DOCKER_REGISTRY_URL}/${DOCKER_NAMESPACE}/${module}:${BASE_VERSION}"
                    echo "  - ${imageName}"
                }
                echo "ğŸŒ æ¿€æ´»Profile: ${params.DEPLOY_PROFILE}"
                echo "ğŸ”Œ æœåŠ¡ç«¯å£: ${TARGET_PORT}"
            }
        }
        
        // æ„å»ºå¤±è´¥åçš„å¤„ç†
        failure {
            echo "âŒ æµæ°´çº¿æ‰§è¡Œå¤±è´¥"
        }
        
        // æ— è®ºæˆåŠŸå¤±è´¥éƒ½ä¼šæ‰§è¡Œçš„å¤„ç†
        always {
            echo "ğŸ“Š æ„å»ºä¿¡æ¯ï¼š"
            echo "  æ„å»ºç¼–å·: #${BUILD_NUMBER}"
            echo "  ç‰ˆæœ¬æ ‡ç­¾: ${BASE_VERSION}"
            echo "  æ„å»ºæ—¶é—´: ${new Date().format('yyyy-MM-dd HH:mm:ss')}"
        }
    }
}

// å‡½æ•°ï¼šè·å–è¦æ„å»ºçš„æ¨¡å—åˆ—è¡¨
def getModulesToBuild() {
    // å¦‚æœé€‰æ‹©ALLåˆ™æ„å»ºæ‰€æœ‰æ¨¡å—ï¼Œå¦åˆ™æ„å»ºæŒ‡å®šçš„å•ä¸ªæ¨¡å—
    if (params.MODULE_TO_BUILD == 'ALL') {
        return [
            'wy-workflow'
        ]
    } else {
        return [params.MODULE_TO_BUILD]
    }
}

// å‡½æ•°ï¼šæ›´æ–°Dockerfileä¸­çš„Spring Profileé…ç½®
def updateDockerfileProfile(String moduleName) {
    echo "ğŸ“ æ›´æ–°æ¨¡å— ${moduleName} çš„Dockerfile Profile"

    // æ¨¡å—è·¯å¾„æ˜ å°„è¡¨
    def modulePathMap = [
        'wy-workflow': 'blade-service/wy-workflow'  // æ¨¡å—åä¸å®é™…è·¯å¾„çš„æ˜ å°„
    ]

    // è·å–æ¨¡å—å¯¹åº”çš„å®é™…è·¯å¾„
    def modulePath = modulePathMap[moduleName]
    
    // è·å–ç›®æ ‡ç¯å¢ƒé…ç½®
    def targetProfile = params.DEPLOY_PROFILE

    if (!modulePath) {
        echo "âŒ æœªæ‰¾åˆ°æ¨¡å— ${moduleName} çš„è·¯å¾„é…ç½®"
        return
    }

    // åˆ‡æ¢åˆ°æ¨¡å—ç›®å½•æ‰§è¡Œæ“ä½œ
    dir("${modulePath}") {
        if (fileExists('Dockerfile')) {
            try {
                // å¤‡ä»½åŸå§‹Dockerfileï¼Œä½¿ç”¨æ„å»ºç¼–å·ä½œä¸ºå¤‡ä»½æ ‡è¯†
                sh "cp Dockerfile Dockerfile.backup.${BUILD_NUMBER}"

                echo "åŸå§‹Dockerfileå†…å®¹ï¼š"
                sh "head -20 Dockerfile"

                // ä½¿ç”¨sedå‘½ä»¤æ›´æ–°Dockerfileä¸­çš„Spring Profileé…ç½®
                sh """
                    # å¤‡ä»½åŸå§‹å†…å®¹
                    cp Dockerfile Dockerfile.original

                    # åŒ¹é…--spring.profiles.active=åé¢çš„å€¼å¹¶æ›¿æ¢ä¸ºç›®æ ‡Profile
                    # å¤„ç†æ ¼å¼å¦‚ï¼š["--spring.profiles.active=xxx","--server.port=8080"]
                    sed -i 's/--spring.profiles.active=[^,\"]*/--spring.profiles.active=${targetProfile}/g' Dockerfile

                    # éªŒè¯ä¿®æ”¹ç»“æœ
                    echo "Profileä¿®æ”¹åæ£€æŸ¥ï¼š"
                    grep -- "--spring.profiles.active" Dockerfile
                """

                echo "âœ… ${moduleName} çš„Dockerfileæ›´æ–°æˆåŠŸ"
                echo "æ›´æ–°åçš„ç›¸å…³è¡Œï¼š"
                sh "grep -n 'spring.profiles.active\\|CMD\\|ENTRYPOINT' Dockerfile"

            } catch (Exception e) {
                // æ›´æ–°å¤±è´¥æ—¶çš„å¼‚å¸¸å¤„ç†
                echo "âŒ æ›´æ–°Dockerfileå¤±è´¥: ${e.getMessage()}"
                echo "æ¢å¤å¤‡ä»½æ–‡ä»¶..."
                sh "cp Dockerfile.backup.${BUILD_NUMBER} Dockerfile"
            }
        } else {
            echo "âš ï¸  ${modulePath}/Dockerfile ä¸å­˜åœ¨"
        }
    }
}

// å‡½æ•°ï¼šæ„å»ºDockeré•œåƒ
def buildDockerImage(String moduleName) {
    echo "ğŸš€ å¼€å§‹æ„å»ºæ¨¡å—: ${moduleName}"

    // æ¨¡å—è·¯å¾„æ˜ å°„è¡¨
    def modulePathMap = [
        'wy-workflow': 'blade-service/wy-workflow'
    ]

    // è·å–æ¨¡å—å¯¹åº”çš„å®é™…è·¯å¾„
    def modulePath = modulePathMap[moduleName]

    if (!modulePath) {
        echo "âŒ æœªæ‰¾åˆ°æ¨¡å— ${moduleName} çš„è·¯å¾„é…ç½®"
        return
    }

    // åˆ‡æ¢åˆ°æ¨¡å—ç›®å½•æ‰§è¡Œæ“ä½œ
    dir("${modulePath}") {
        if (fileExists('pom.xml')) {
            try {
                echo "ğŸ“„ æ‰§è¡ŒDockeræ„å»º..."
                echo "ğŸ·ï¸  é•œåƒ: ${DOCKER_REGISTRY_URL}/${DOCKER_NAMESPACE}/${moduleName}:${BASE_VERSION}"
                echo "âš™ï¸  Profile: ${params.DEPLOY_PROFILE}"

                // éªŒè¯Dockerfileä¸­çš„é…ç½®æ˜¯å¦æ­£ç¡®æ›´æ–°
                echo "ğŸ” éªŒè¯Dockerfileé…ç½®:"
                sh """
                    echo "Dockerfileä¸­çš„profileé…ç½®:"
                    grep -i "spring.profiles.active" Dockerfile || echo "æœªæ‰¾åˆ°profileé…ç½®"
                    echo ""
                    echo "å®Œæ•´çš„CMD/ENTRYPOINTè¡Œ:"
                    grep -E "CMD|ENTRYPOINT" Dockerfile || echo "æœªæ‰¾åˆ°å¯åŠ¨å‘½ä»¤"
                """

                // ä½¿ç”¨Maven Dockeræ’ä»¶æ„å»ºå’Œæ¨é€é•œåƒ
                sh """
                    mvn docker:build docker:push \
                        -s ${MAVEN_SETTINGS} \
                        -Ddocker.fabric.skip=false \
                        -Ddocker.registry.url=${DOCKER_REGISTRY_URL} \
                        -Ddocker.username=${DOCKER_USERNAME} \
                        -Ddocker.password=${DOCKER_PASSWORD} \
                        -Ddocker.namespace=${DOCKER_NAMESPACE} \
                        -Ddocker.image.tag=${BASE_VERSION}
                """
                
                echo "âœ… ${moduleName} æ„å»ºæˆåŠŸ"
                echo "ğŸ“¦ é•œåƒåœ°å€: ${DOCKER_REGISTRY_URL}/${DOCKER_NAMESPACE}/${moduleName}:${BASE_VERSION}"
                echo "âš™ï¸  è¿è¡Œæ—¶å‚æ•°: --spring.profiles.active=${params.DEPLOY_PROFILE} --server.port=${TARGET_PORT}"

            } catch (Exception e) {
                // æ„å»ºå¤±è´¥æ—¶çš„å¼‚å¸¸å¤„ç†
                echo "âŒ ${moduleName} æ„å»ºå¤±è´¥: ${e.getMessage()}"
                // æ³¨æ„ï¼šè¿™é‡Œåªæ˜¯è®°å½•é”™è¯¯ï¼Œä¸ä¼šä¸­æ–­å…¶ä»–æ¨¡å—çš„æ„å»º
            }
        } else {
            echo "âš ï¸  ${modulePath}/pom.xml ä¸å­˜åœ¨"
        }
    }
}


```